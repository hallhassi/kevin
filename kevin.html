<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>larmee</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            line-height: 1em;
            background-color: gray;
            color: white;
            font-family: monospace;
        }

        h1,
        h2 {
            line-height: 1;
            text-align: center;
            margin: 2rem 0;
            padding: 1rem 0;
            font-family: auto;
        }

        body>a {
            position: fixed;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
        }

        canvas {
            max-height: 100vh;
            max-width: 100vw;
            position: sticky;
            top: 0;
            margin: auto;
        }

        img {
            display: block;
            margin: auto;
            padding: 1.5vh 1.5vw;
            max-width: 30vw;
            max-height: 100%;
        }

        a {
            text-decoration: none;
        }

        summary {
            text-align: center;
            padding: 5rem 0;
        }

        #thumbs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }

        .thumb {
            width: 100%;

        }

        div#scrub>span {
            text-align: center;
            display: block;
        }

        details#bio>div {
            margin: auto;
            width: 92vw;
        }

        .pt0 {
            padding-top: 0;
        }

        section {
            margin-bottom: 3rem;
        }

        ul {
            list-style-type: none;
        }

        .year {
            padding-left: 5ch;
            text-indent: -5ch;
        }

        .hide {
            display: none;
        }

        .on {
            grid-column: 1 / span 3;
        }

        div.on>img {
            max-width: calc(97vw - 6rem);
            max-height: 97vh;
        }

        div.on>details>* {
            padding: 1rem;
            text-align: left;
        }

        #full {
            background-color: gray;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        #full>img {
            position: fixed;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
            max-width: 97vw;
            max-height: 97vh;
        }

        #full>img#hi {
            max-width: none;
            max-height: none;
        }

        .noscroll {
            overflow: hidden;
        }
    </style>
</head>

<body>
    <h1>Kevin Larmee</h1>
    <main></main>
    <script>
        let json,
            dirs = [],
            state,
            request = new XMLHttpRequest(),
            html = document.documentElement,
            canvas = document.createElement('canvas'),
            context = canvas.getContext("2d"),
            small = 400,
            med = 800,
            srcSmall = `https://larmee.mo.cloudinary.net/${small}/`,
            srcMed = `https://larmee.mo.cloudinary.net/${med}/`,
            srcBig = 'https://res.cloudinary.com/hallhassi/image/upload/kevin/',
            main = document.querySelector('main'),
            a = document.querySelector('body>a'),
            on,
            cols = 3,
            imgs = [],
            height = 16

        let div = document.createElement('div'),
            img = document.createElement('img')
        div.id = 'full'
        div.classList.add('hide')
        div.append(img)
        main.append(div)
        let full = document.querySelector('div#full'),
            fullimg = document.querySelector('div#full>img')

        request.addEventListener("load", reqListener);
        // xhr.open("GET", "https://api.jsonbin.io/v3/b/62d586a6b34ef41b73c72f38", true);
        request.open("GET", "kevin.json", true);
        request.setRequestHeader("X-Master-Key", "$2b$10$TibiNXzqvzPyK7VremUTCujPDF0bfwlS5y7LiRVkSChPp6V6kFydm");
        request.setRequestHeader("X-Bin-Meta", false);
        request.send();

        function clear() {
            fullimg.parentElement.classList.add('hide')
            document.body.classList.remove('noscroll')
            window.removeEventListener('click', clear)
        }

        window.addEventListener('click', e => {
            console.log(e.target)
            console.log(e.target.parentElement)
        })

        window.addEventListener('click', e => {
            if (e.target.parentElement.classList.contains('thumb')) {
                let thumb = e.target.parentElement,
                    med = window.innerWidth > small + 200 ? e.target.dataset.src : e.target.src
                if (thumb.classList.contains('on')) {
                    document.body.classList.add('noscroll')
                    full.classList.remove('hide')
                    fullimg.src = e.target.dataset.src
                    window.addEventListener('click', clear)
                } else {
                    if (on !== undefined) {
                        on.classList.remove('on')
                        on.childNodes[1].classList.add('hide')
                    }
                    e.target.src = med
                    document.querySelector('div.thumb').style.gridColumnStart = (cols - thumb.dataset.col) % 3 + 1
                    thumb.classList.add('on')
                    let scrollAmount = e.target.parentElement.getBoundingClientRect().y + Math.round(window.scrollY)
                    scrollAmount -= (window.innerHeight / window.innerWidth) > (e.target.clientHeight / e.target.clientHeight) ? ((window.innerHeight - e.target.clientHeight) / 2) : 0
                    window.scroll(0, scrollAmount)
                    on = thumb
                    thumb.childNodes[1].classList.remove('hide')
                }
            } else if (e.target.parentElement.id == 'drawings') {
                if (e.target.parentElement.open !== true) {
                    document.querySelector('details#bio>summary').classList.add('pt0');
                } else document.querySelector('details#bio>summary').classList.remove('pt0');
            }
        })


            function reqListener() {
                json = JSON.parse(this.responseText)
                json.forEach(d => {
                    let details = document.createElement('details'),
                        summary = document.createElement('summary'),
                        a = document.createElement('a'),
                        wrap = document.createElement('div')
                    if (d.type == "thumbs") {
                        d.images.forEach((f, i) => {
                            let img = new Image(),
                                details = document.createElement('details'),
                                summary = document.createElement('summary'),
                                ul = document.createElement('ul'),
                                div = document.createElement('div'),
                                colnum = i % 3
                            Object.entries(f).forEach(([key, value]) => {
                                if (key !== "url") {
                                    let li = document.createElement('li')
                                    li.append(`${key}: ${value}`);
                                    ul.append(li)
                                }
                            });
                            img.src = srcSmall + f.url
                            img.classList.add('scroll')
                            img.dataset.src = srcBig + f.url
                            details.classList.add('hide')
                            summary.append('i')
                            summary.classList.add('name')
                            details.append(summary)
                            details.append(ul)
                            div.append(img)
                            div.append(details)
                            div.dataset.col = colnum
                            div.classList.add('thumb')
                            wrap.append(div)
                        })
                    }
                    if (d.type == "scrub") {
                        d.images.forEach(f => {
                            let img = new Image(),
                                span = document.createElement('span'),
                                url = f.url
                            img.src = srcMed + f.url
                            imgs.push({ "img": img, "url": url })
                        })
                        draw(imgs[0])
                        wrap.append(canvas)
                        wrap.style.height = d.images.length * height + document.documentElement.clientHeight + 'px'
                    }
                    if (d.type == "lists") {
                        d.sections.forEach(s => {
                            let section = document.createElement('section'),
                                h2 = document.createElement('h2'),
                                ul = document.createElement('ul')
                            s.entries.forEach(e => {
                                li = document.createElement('li')
                                if (e.year) {
                                    li.append(e.year + ' ')
                                    li.classList.add('year')
                                }
                                li.append(e.content)
                                ul.append(li)
                            })
                            h2.append(s.name)
                            section.append(h2, ul)
                            wrap.append(section)
                        })
                    }
                    summary.append(d.name)
                    summary.classList.add('scroll')
                    details.append(summary)
                    wrap.id = d.type
                    details.append(wrap)
                    details.id = d.name
                    main.append(details)
                })
                canvas = document.querySelector('canvas')
            }

            window.addEventListener('scroll', () => {
                let y = -Math.floor((document.getElementById('scrub').getBoundingClientRect().y / height))
                if (y >= 0) {
                    window.addEventListener('scroll', () => {
                        requestAnimationFrame(() => scrub(y))
                    })
                }
            })

            function scrub(y) {
                let img = imgs[y]
                if (img) {
                    draw(img)
                } else {
                    resetCanvas()
                }
            }

            function draw(img) {
                canvas.width = img.img.naturalWidth
                canvas.height = img.img.naturalHeight
                context.drawImage(img.img, 0, 0, canvas.width, canvas.height)
            }

            function resetCanvas() {
                context.clearRect(0, 0, canvas.width, canvas.height)
                canvas.width = 0
                canvas.height = 0
            }

            const keyMap = {};
            onkeydown = onkeyup = function (event) {
                keyMap[event.key] = event.type == 'keydown';
            }
            document.body.addEventListener("keydown", function (event) {
                if (event.key == 'ArrowLeft' && keyMap['Alt'] !== 'true' && keyMap['Meta'] !== 'true') {
                    window.scrollBy(0, -height)
                } else if (event.key == 'ArrowRight' && keyMap['Alt'] !== 'true' && keyMap['Meta'] !== 'true') {
                    window.scrollBy(0, height)
                } else if (event.key == 'ArrowUp' && keyMap['Alt'] !== 'true' && keyMap['Meta'] !== 'true') {
                    event.preventDefault()
                    window.scrollBy(0, -height)
                } else if (event.key == 'ArrowDown' && keyMap['Alt'] !== 'true' && keyMap['Meta'] !== 'true') {
                    event.preventDefault()
                    window.scrollBy(0, height)
                }
            });

    </script>
</body>

</html>